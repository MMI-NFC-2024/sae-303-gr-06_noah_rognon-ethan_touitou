---
import * as d3 from "d3";
import * as Plot from "@observablehq/plot";
import { readFileSync } from "fs";
import { fileURLToPath } from "url";
import path from "path";
import PlotFigure from "../components/PlotFigure.astro";

// ===========================
// CONFIG G√âN√âRALE
// ===========================
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const dataDir = path.resolve(__dirname, "../../public/data");

// ===========================
// SECTION 1 ‚Äî R√©seau ferroviaire et culture
// ===========================
const departements = JSON.parse(
    readFileSync(path.join(dataDir, "departements.geojson"), "utf-8"),
);

const lignes1 = d3
    .dsvFormat(";")
    .parse(
        readFileSync(
            path.join(dataDir, "lignes-par-region-administrative.csv"),
            "utf-8",
        ),
        d3.autoType,
    );

const lignes_valides = lignes1
    .filter((d) => d.X_D_WGS84 && d.Y_D_WGS84 && d.X_F_WGS84 && d.Y_F_WGS84)
    .map((d) => ({
        ...d,
        X_D_WGS84: parseFloat(String(d.X_D_WGS84).replace(",", ".")),
        Y_D_WGS84: parseFloat(String(d.Y_D_WGS84).replace(",", ".")),
        X_F_WGS84: parseFloat(String(d.X_F_WGS84).replace(",", ".")),
        Y_F_WGS84: parseFloat(String(d.Y_F_WGS84).replace(",", ".")),
    }));

const gares = d3
    .dsvFormat(";")
    .parse(
        readFileSync(path.join(dataDir, "gares-de-voyageurs.csv"), "utf-8"),
        d3.autoType,
    );
const gares_clean = gares.filter((d) => d["Position g√©ographique"]);

const equipements = d3
    .dsvFormat(",")
    .parse(
        readFileSync(
            path.join(dataDir, "googleBasilicDataculture20250905Sheet1.csv"),
            "utf-8",
        ),
        d3.autoType,
    );

const equipements_culturels = equipements.filter((d) =>
    ["Archives", "Biblioth√®que", "Th√©√¢tre", "Cin√©ma"].some(
        (cat) =>
            (d.Domaine || "").includes(cat) ||
            (d.Type_equipement_ou_lieu || "").includes(cat),
    ),
);

const plotOptions1 = {
    title: "R√©seau ferroviaire et acc√®s √† la culture en France",
    subtitle:
        "Visualisation des lignes ferroviaires (en noir), des gares SNCF (en rouge) et des √©quipements culturels (en bleu).",
    width: 950,
    height: 780,
    projection: { type: "mercator", domain: departements },
    marks: [
        Plot.geo(departements, { fill: "#f3f4f6", stroke: "#d1d5db" }),
        Plot.link(lignes_valides, {
            x1: "X_D_WGS84",
            y1: "Y_D_WGS84",
            x2: "X_F_WGS84",
            y2: "Y_F_WGS84",
            stroke: "#000",
            strokeWidth: 1.5,
            opacity: 0.9,
        }),
        Plot.dot(gares_clean, {
            x: "Longitude",
            y: "Latitude",
            r: 2,
            fill: "#ef4444",
            opacity: 0.8,
        }),
        Plot.dot(equipements_culturels, {
            x: "Longitude",
            y: "Latitude",
            r: 3,
            fill: "#3b82f6",
            opacity: 0.6,
        }),
    ],
    style: { background: "#fafafa", color: "#111827" },
};

// ===========================
// SECTION 2 ‚Äî √âmissions CO‚ÇÇ
// ===========================
const co2 = [
    { mode: "Train", co2: 4 },
    { mode: "Voiture", co2: 40 },
    { mode: "Avion", co2: 70 },
];

const plotOptions2 = {
    title: "√âmissions moyennes de CO‚ÇÇ par mode de transport (trajet de 500 km)",
    subtitle: "Source : ADEME, SNCF ‚Äì donn√©es moyennes estim√©es",
    x: { label: "Mode de transport" },
    y: { label: "√âmissions de CO‚ÇÇ (kg)" },
    marks: [
        Plot.barY(co2, {
            x: "mode",
            y: "co2",
            fill: (d) =>
                d.mode === "Train"
                    ? "green"
                    : d.mode === "Voiture"
                      ? "orange"
                      : "red",
        }),
        Plot.text(co2, {
            x: "mode",
            y: (d) => d.co2 + 3,
            text: (d) => `${d.co2} kg`,
            textAnchor: "middle",
            fontWeight: "bold",
        }),
    ],
};

// ===========================
// SECTION 3 ‚Äî Festivals accessibles en train
// ===========================
const festivals = d3
    .dsvFormat(";")
    .parse(
        readFileSync(
            path.join(dataDir, "festivals-global-festivals-pl.csv"),
            "utf-8",
        ),
        d3.autoType,
    );

const festivals_clean = festivals.filter((d) => d["G√©ocodage xy"]);

function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

const festivals_accessibles = festivals_clean
    .map((f) => {
        const [latF, lonF] = String(f["G√©ocodage xy"] || "")
            .split(",")
            .map((c) => parseFloat(c.trim()));
        if (!latF || !lonF) return null;

        let minDistance = Infinity;
        for (const g of gares_clean) {
            const [latG, lonG] = String(g["Position g√©ographique"] || "")
                .split(",")
                .map((c) => parseFloat(c.trim()));
            if (!latG || !lonG) continue;
            const dist = distanceKm(latF, lonF, latG, lonG);
            if (dist < minDistance) minDistance = dist;
        }

        return {
            ...f,
            latitude: latF,
            longitude: lonF,
            distance_gare: minDistance,
        };
    })
    .filter(Boolean);

const festivals_accessibles_train = festivals_accessibles.filter(
    (f) => f.distance_gare <= 10,
);
const festivals_non_accessibles = festivals_accessibles.filter(
    (f) => f.distance_gare > 10,
);

const plotOptions3 = {
    title: "Festivals accessibles en train (‚â§ 10 km d‚Äôune gare)",
    width: 950,
    height: 700,
    projection: { type: "mercator", domain: departements },
    marks: [
        Plot.geo(departements, { fill: "#f8f8f8", stroke: "#ccc" }),
        Plot.dot(gares_clean, {
            x: (d) => +d["Position g√©ographique"].split(",")[1],
            y: (d) => +d["Position g√©ographique"].split(",")[0],
            r: 1,
            fill: "#999",
            opacity: 0.3,
        }),
        Plot.dot(festivals_accessibles_train, {
            x: (d) => d.longitude,
            y: (d) => d.latitude,
            r: 2.5,
            fill: "#2a9d8f",
            opacity: 0.85,
        }),
        Plot.dot(festivals_non_accessibles, {
            x: (d) => d.longitude,
            y: (d) => d.latitude,
            r: 2.5,
            fill: "#e63946",
            opacity: 0.6,
        }),
    ],
    style: { background: "#fafafa" },
};

// ===========================
// SECTION 4 ‚Äî √âvolution du co√ªt et du CO‚ÇÇ √©conomis√©
// ===========================
const couts = [
    { Ann√©e: 2010, Train: 9.5, Voiture: 8.0, CO2: 8.0 },
    { Ann√©e: 2012, Train: 9.8, Voiture: 8.3, CO2: 8.3 },
    { Ann√©e: 2014, Train: 10.1, Voiture: 8.6, CO2: 8.7 },
    { Ann√©e: 2016, Train: 10.3, Voiture: 8.8, CO2: 8.9 },
    { Ann√©e: 2018, Train: 10.6, Voiture: 9.0, CO2: 9.0 },
    { Ann√©e: 2019, Train: 10.8, Voiture: 9.1, CO2: 9.2 },
    { Ann√©e: 2020, Train: 10.5, Voiture: 8.7, CO2: 8.8 },
    { Ann√©e: 2021, Train: 11.0, Voiture: 9.5, CO2: 9.3 },
    { Ann√©e: 2022, Train: 11.8, Voiture: 10.2, CO2: 9.6 },
    { Ann√©e: 2023, Train: 12.1, Voiture: 10.5, CO2: 9.8 },
    { Ann√©e: 2024, Train: 12.3, Voiture: 10.7, CO2: 10.0 },
];

const dataCouts = couts.flatMap((d) =>
    Object.entries(d)
        .filter(([k]) => !["Ann√©e", "CO2"].includes(k))
        .map(([mode, cout]) => ({
            Ann√©e: +d.Ann√©e,
            Mode: mode,
            Co√ªt: +cout,
        })),
);

const plotOptions4 = {
    title: "√âvolution du co√ªt et du CO‚ÇÇ √©conomis√© (2010‚Äì2024)",
    subtitle:
        "Comparaison du co√ªt du train et de la voiture, et gains environnementaux associ√©s.",
    width: 950,
    height: 520,
    marginLeft: 80,
    marginRight: 60,
    color: {
        legend: true,
        domain: ["Train", "Voiture", "CO‚ÇÇ √©conomis√©"],
        range: ["#2563eb", "#ef4444", "#16a34a"],
    },
    x: { label: "Ann√©e", tickFormat: d3.format("d"), grid: true },
    y: { label: "Co√ªt moyen (‚Ç¨ / 100 km)", grid: true, domain: [7, 13] },
    marks: [
        Plot.line(dataCouts, {
            x: "Ann√©e",
            y: "Co√ªt",
            stroke: "Mode",
            strokeWidth: 3,
        }),
        Plot.dot(dataCouts, {
            x: "Ann√©e",
            y: "Co√ªt",
            fill: "Mode",
            r: 4,
            title: (d) =>
                `${d.Mode} (${d.Ann√©e}) : ${d.Co√ªt.toFixed(2)} ‚Ç¨ / 100 km`,
        }),
        Plot.line(couts, {
            x: "Ann√©e",
            y: (d) => d.CO2,
            stroke: "#16a34a",
            strokeDasharray: "4,2",
            strokeWidth: 2,
            title: (d) =>
                `${d.Ann√©e} : ${d.CO2.toFixed(1)} kg de CO‚ÇÇ √©conomis√©s / 100 km`,
        }),
        Plot.text([{ x: 2024, y: 10, text: "CO‚ÇÇ √©conomis√© (kg / 100 km)" }], {
            text: "text",
            x: "x",
            y: "y",
            dx: 40,
            dy: -10,
            fill: "#16a34a",
        }),
    ],
    style: { background: "#fafafa", color: "#111827" },
};
---

<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <title>Visualisations ferroviaires et environnementales</title>
    </head>
    <body style="padding:2rem;">
        <h1>Visualisations : mobilit√©, culture et impact environnemental</h1>

        <section>
            <h2>Section 1 ‚Äî R√©seau ferroviaire et √©quipements culturels</h2>
            <PlotFigure options={plotOptions1} />
        </section>

        <section>
            <h2>Section 2 ‚Äî √âmissions moyennes de CO‚ÇÇ par mode</h2>
            <PlotFigure options={plotOptions2} />
        </section>

        <section>
            <h2>Section 3 ‚Äî Festivals accessibles en train (‚â§ 10 km)</h2>
            <PlotFigure options={plotOptions3} />
            <p>
                üü¢ Vert = accessible en train (‚â§ 10 km d‚Äôune gare) üî¥ Rouge =
                √©loign√© (non accessible directement) ‚ö™ Gares = r√©seau
                ferroviaire
            </p>
        </section>

        <section>
            <h2>
                Section 4 ‚Äî √âvolution du co√ªt et du CO‚ÇÇ √©conomis√© (2010‚Äì2024)
            </h2>

            <label for="filtreMode" style="font-weight:bold;"
                >Filtrer par mode :</label
            >
            <select id="filtreMode" style="margin-left:0.5rem; padding:0.3rem;">
                <option value="Tous">Tous</option>
                <option value="Train">Train</option>
                <option value="Voiture">Voiture</option>
            </select>

            <div id="graph-couts" style="margin-top:1.5rem;"></div>

            <!-- ‚úÖ Chemin vers le script c√¥t√© public -->
            <script type="module" src="/scripts/evolution.js"></script>
        </section>
        <!-- SECTION 5 -->
        <section>
            <h2>
                Section 5 ‚Äî Avantages du train vs inconv√©nients de la voiture
            </h2>

            <label for="filtreAvantages" style="font-weight:bold;"
                >Filtrer par type :</label
            >
            <select
                id="filtreAvantages"
                style="margin-left:0.5rem; padding:0.3rem;"
            >
                <option value="Tous">Tous</option>
                <option value="Avantage Train">Avantage Train</option>
                <option value="Inconv√©nient Voiture"
                    >Inconv√©nient Voiture</option
                >
            </select>

            <div id="graph-avantages" style="margin-top:1.5rem;"></div>

            <script type="module" src="/scripts/avantages.js"></script>

            <p style="margin-top:1rem;">
                Le train marque des points forts sur l‚Äô√©cologie, le confort et
                la r√©duction du stress. La voiture conserve un avantage
                d‚Äôaccessibilit√©, reflet d‚Äôun r√©seau routier ubiquitaire. Cette
                comparaison nourrit le discours marketing : valoriser
                l‚Äôexp√©rience qualitative du rail (repos, s√©curit√©, empreinte
                carbone) et √©clairer les conditions d‚Äôusage pour lever les
                freins restants.
            </p>
        </section>
        <section>
            <h2>Section 6 ‚Äî Disponibilit√© moyenne des offres TGVMax par axe</h2>
            <div id="graph-tgvmax" style="margin-top:1.5rem;"></div>
            <script type="module" src="/scripts/tgvmax.js"></script>
        </section>
        <section>
            <h2>Section 7 ‚Äî Accessibilit√© touristique autour des gares</h2>

            <div id="graph-accessibilite" style="margin-top:1.5rem;"></div>

            <script type="module" src="/scripts/tourisme.js"></script>

            <p style="margin-top:1rem;">
                Les gares des grandes m√©tropoles (Paris, Lyon, Marseille, Lille,
                Toulouse) concentrent logiquement le plus de POI touristiques.
                Mais la carte r√©v√®le aussi des ‚Äúgares d‚Äôint√©r√™t local‚Äù ‚Äî
                stations baln√©aires, villages class√©s ‚Äî avec un haut ratio
                POI/gares, indiquant des leviers forts pour le tourisme durable.
                Cette visualisation relie directement le train √† la d√©couverte
                culturelle et naturelle de proximit√©.
            </p>
        </section>
        <section>
            <h2>
                Section 8 ‚Äî Part modale des transports de voyageurs en France
            </h2>
            <div id="graph-partmodale"></div>

            <script type="module" src="/scripts/partModale.js"></script>

            <p style="margin-top: 1rem;">
                Ce graphique illustre l‚Äô√©volution de la r√©partition des modes de
                transport en France entre 2010 et 2024. On observe une l√©g√®re
                hausse du train, une baisse progressive de la voiture et une
                stabilit√© de l‚Äôavion et du bus.
            </p>
        </section>
        <section>
            <h2>Section 9 ‚Äî Le train : champion du climat</h2>
            <div id="graph-trainco2"></div>

            <script type="module" src="/scripts/trainCO2.js"></script>

            <p style="margin-top: 1rem;">
                Ce graphique met en √©vidence la sobri√©t√© du train face aux
                autres modes de transport. En 2024, un trajet en train √©met
                environ <strong>1,2 g de CO‚ÇÇ</strong>
                par passager-kilom√®tre, contre pr√®s de <strong
                    >100 g pour la voiture</strong
                > et plus de <strong>200 g pour l‚Äôavion</strong>.
            </p>
        </section>
        <section>
            <h2>Section 10 ‚Äî Mobilit√© 2035 : le futur du transport durable</h2>
            <div id="graph-mobilite2035"></div>

            <script type="module" src="/scripts/mobilite2035.js"></script>

            <p style="margin-top: 1rem;">
                Cette projection illustre l‚Äô√©volution de la fr√©quentation
                ferroviaire et des √©missions de CO‚ÇÇ dans un sc√©nario de
                transition modale. En 2035, le transfert de 10 % des trajets
                voiture vers le train permettrait de r√©duire les √©missions
                globales du secteur tout en doublant presque la fr√©quentation
                ferroviaire.
            </p>
        </section>
        <section>
            <h2>Section 11 ‚Äî Les destinations durables du tourisme en train</h2>
            <div id="graph-tourisme"></div>

            <script type="module" src="/scripts/tourismeCarte.js"></script>

            <p style="margin-top: 1rem;">
                Cette carte interactive met en √©vidence les correspondances
                entre les gares ferroviaires, les lieux touristiques et les
                festivals accessibles par le rail. Les filtres permettent
                d‚Äôexplorer les diff√©rentes cat√©gories culturelles et disciplines
                artistiques pour une lecture plus fine du tourisme durable en
                France.
            </p>
        </section>
        <section>
            <h2>Section 12 ‚Äî Taux de disponibilit√© TGVMax par axe</h2>
            <div id="graph-tgvmax-axe"></div>

            <script type="module" src="/scripts/tgvmaxDispo.js"></script>

            <p style="margin-top: 1rem;">
                Ce graphique illustre la disponibilit√© moyenne des billets
                TGVMax selon les axes principaux du r√©seau. Le s√©lecteur permet
                de comparer les variations dans le temps pour chaque ligne,
                r√©v√©lant les zones √† forte demande et les p√©riodes de tension
                sur la r√©servation.
            </p>
        </section>
        <section>
            <h2>Section ‚Äî Accessibilit√© touristique selon le rayon</h2>

            <div id="graph-accessibilite-rayon" style="margin-top:1.5rem;">
            </div>

            <script type="module" src="/scripts/accessibilite-rayon.js"
            ></script>

            <p style="margin-top:1rem;">
                Cette carte permet d‚Äôexplorer la densit√© de points d‚Äôint√©r√™t
                accessibles depuis les gares selon un rayon choisi et un type de
                POI (h√©bergement, patrimoine, nature‚Ä¶). Elle illustre
                concr√®tement le potentiel du train pour le tourisme durable de
                proximit√©.
            </p>
        </section>

        <section>
            <h2>Section ‚Äî Taux de disponibilit√© TGVMax</h2>

            <div id="ah" style="margin-top:1.5rem;"></div>

            <script type="module" src="/scripts/disponibilite.js"></script>

            <p style="margin-top:1rem;">
                Ce graphique illustre l‚Äô√©volution du taux de disponibilit√© des
                offres MAX sur les diff√©rents axes TGV. Chaque case repr√©sente
                un jour et un axe : plus la couleur est fonc√©e, plus la
                disponibilit√© est √©lev√©e. Les √©toiles marquent les jours o√π le
                taux d√©passe 50 %.
            </p>
        </section>
        <section>
            <h2>
                üöÜ Section ‚Äî Carte du r√©seau ferroviaire et des √©quipements
                culturels
            </h2>

            <label for="filtre-carte" style="font-weight:bold;"
                >Filtrer l‚Äôaffichage :</label
            >
            <select
                id="filtre-carte"
                style="margin-left:0.5rem; padding:0.3rem;"
            >
                <option value="tous">Toutes les donn√©es</option>
                <option value="gares">Seulement les gares</option>
                <option value="lignes">Seulement les lignes</option>
            </select>

            <div id="graph-reseau-ferroviaire" style="margin-top:1.5rem;"></div>

            <script type="module" src="/scripts/reseau-ferroviaire.js"></script>

            <p style="margin-top:1rem;">
                Cette carte illustre le maillage du r√©seau SNCF √† travers la
                France, en montrant les lignes ferroviaires (vertes) et la
                localisation des gares voyageurs (rouges).
            </p>
        </section>
    </body>
</html>
